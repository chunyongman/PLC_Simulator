# PLC Simulator

## 개요
실제 PLC를 대신하여 센서 데이터와 장비 상태를 시뮬레이션하는 Modbus TCP 서버입니다.

## 역할
1. **센서 데이터 생성**: 온도, 압력, 부하 센서 시뮬레이션
2. **장비 상태 관리**: 펌프/팬 운전 상태 시뮬레이션
3. **Edge AI 결과 저장**: Edge AI가 계산한 결과를 레지스터에 저장
4. **HMI 데이터 제공**: HMI가 읽을 수 있도록 모든 데이터 제공

## 시스템 요구사항
- Python 3.8 이상
- Windows 10 이상
- **관리자 권한** (포트 502 사용)

## 설치 및 실행

### 방법 1: 자동 실행 (권장)
```batch
START.bat (관리자 권한으로 실행)
```
→ 자동으로 가상환경 생성 및 의존성 설치 후 실행

### 방법 2: 수동 실행
```batch
# 1. 가상환경 생성
python -m venv venv

# 2. 가상환경 활성화
venv\Scripts\activate

# 3. 의존성 설치
pip install -r requirements.txt

# 4. 프로그램 실행 (관리자 권한)
python plc_simulator.py
```

## 네트워크 설정

### 기본 설정
- **IP 주소**: 0.0.0.0 (모든 인터페이스)
- **포트**: 502 (Modbus TCP 표준)
- **Slave ID**: 3

### 3개 장비 연결 시
```
사용자 PC (PLC Simulator): 192.168.1.10
    ↓
Edge Computer: 192.168.1.30 (PLC에서 읽기 + PLC로 쓰기)
    ↓
HMI 장비: 192.168.1.20 (PLC에서 읽기만)
```

## Modbus 레지스터 맵

### 센서 데이터 (Read-Only)
| 주소 | 항목 | 설명 | 포맷 |
|------|------|------|------|
| 10 | TX1 | CSW PP Disc Temp | °C × 10 |
| 11 | TX2 | No.1 CLR SW Out Temp | °C × 10 |
| 12 | TX3 | No.2 CLR SW Out Temp | °C × 10 |
| 13 | TX4 | CLR FW In Temp | °C × 10 |
| 14 | TX5 | CLR FW Out Temp | °C × 10 |
| 15 | TX6 | E/R Inside Temp | °C × 10 |
| 16 | TX7 | E/R Outside Temp | °C × 10 |
| 17 | PX1 | CSW PP Disc Press | kg/cm² × 4608 |
| 18 | DPX2 | E/R Diff Press | Pa × 10 |
| 19 | PU1 | M/E Load | % × 276.48 |

### 장비 상태 (Read-Only)
| 주소 | 항목 | 설명 |
|------|------|------|
| 4000-4001 | Equipment Status | 비트 플래그 (RUN, ESS, ABNR) |

### VFD 운전 데이터 (Read-Only)
| 주소 | 항목 | 설명 |
|------|------|------|
| 160-238 | VFD Data | 10개 장비 × 8 레지스터 |

**각 장비당 8 레지스터**:
- [0] Frequency (Hz × 10)
- [1] Power (kW)
- [2] Average Power (kW)
- [3-4] Savings (kWh) - Edge AI가 계산
- [5] Savings Ratio (%) - Edge AI가 계산
- [6-7] Run Hours

### Edge AI 결과 저장 영역 (Write by Edge AI)
| 주소 | 항목 | 설명 | 포맷 |
|------|------|------|------|
| 5000-5009 | AI 목표 주파수 | 각 장비별 목표 주파수 | Hz × 10 |
| 5100-5109 | 절감 전력 | 각 장비별 절감 전력 | kW × 10 |
| 5200-5209 | VFD 진단 점수 | 각 장비별 진단 점수 | 0-100 |
| 5300 | 전체 시스템 절감률 | 실시간 절감률 | % × 10 |
| 5301 | SW 펌프 절감률 | SW 펌프 그룹 절감률 | % × 10 |
| 5302 | FW 펌프 절감률 | FW 펌프 그룹 절감률 | % × 10 |
| 5303 | E/R 팬 절감률 | E/R 팬 그룹 절감률 | % × 10 |

## 시뮬레이션 기능

### 센서 데이터
- **온도**: 기준값 ± 랜덤 변동
- **압력**: 기준값 ± 랜덤 변동
- **M/E 부하**: 20-80% 범위 내 변동

### 알람 시나리오
- **주기**: 60초마다 15초간 알람 조건 생성
- **알람 조건**:
  - 🔴 주기관 부하 과다 (90%)
  - 🔴 외부 공기 온도 상승 (42°C)
  - ⚠️ E/R 내부 온도 상승 (52°C)
  - ⚠️ SW 압력 저하 (1.3 kg/cm²)

### 장비 상태
- **SWP1, SWP2**: 운전 중, ESS 모드
- **FWP1, FWP2**: 운전 중, ESS 모드
- **FAN1, FAN2**: 정방향 운전 중
- **SWP3, FWP3, FAN3, FAN4**: 정지

## 실제 PLC로 교체하기

### PLC 프로그램 요구사항
1. **Modbus TCP 서버**: 포트 502, Slave ID 3
2. **센서 입력**: 아날로그 입력 → 레지스터 10-19
3. **장비 상태**: 디지털 입력 → 레지스터 4000-4001
4. **VFD 통신**: VFD에서 주파수, 전력 읽기 → 레지스터 160-238
5. **Edge AI 결과 수신**: 레지스터 5000-5399 준비

### 교체 절차
1. PLC Simulator 중지
2. 실제 PLC를 192.168.1.10:502로 설정
3. 위의 레지스터 맵대로 PLC 프로그램 작성
4. Edge AI와 HMI의 설정 변경 없음!
   - Edge AI: `config.py`의 `PLC_HOST="192.168.1.10"` 그대로 사용
   - HMI: Backend 설정의 PLC IP 그대로 사용

## 문제 해결

### 포트 502 바인딩 실패
**증상**: `Permission denied: 502`

**해결**:
1. 관리자 권한으로 실행
2. 다른 프로그램이 502 포트를 사용 중인지 확인:
   ```
   netstat -ano | findstr :502
   ```
3. 방화벽에서 502 포트 개방

### Python 환경 오류
**증상**: `python: command not found`

**해결**:
1. Python 3.8 이상 설치
2. PATH 환경 변수에 Python 추가

## 로그 출력

### 시작 시
```
======================================================================
  ESS HMI PLC 시뮬레이터
  Engine Room Ventilation System
======================================================================
[OK] 데이터 스토어 초기화 완료
[INFO] Modbus TCP 서버: 192.168.0.130:502
[INFO] Node ID: 3
[INFO] Edge AI 결과 레지스터: 5000-5399 (Ready)
----------------------------------------------------------------------
```

### 알람 시나리오
```
======================================================================
[시뮬레이터] 🔔 알람 시나리오 시작 (15초간 유지)
  - 🔴 주기관 부하 과다 (PU1: 60% → 90%, CRITICAL)
  - 🔴 외부 공기 온도 상승 (TX7: 25°C → 42°C, CRITICAL)
  - ⚠️ E/R 내부 온도 상승 (TX6: 40°C → 52°C, WARNING)
  - ⚠️ SW 압력 저하 (DPX1: 3.5 → 1.3 kg/cm², WARNING)
======================================================================
```

## 개발자 정보

### 원본 위치
`c:\Users\my\Desktop\HMI_REAL\simulator\plc_simulator.py`

### 주요 수정 사항
1. Edge AI 결과 레지스터 5000-5399 추가
2. VFD 절감량 계산 제거 (Edge AI로 이관)
3. 독립 실행 구조

## 라이선스
내부 사용 전용
